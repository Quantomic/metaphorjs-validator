(function(){window.MetaphorJs={lib:{}};var R=MetaphorJs.getValue=function(){var r=/\r/,b={option:function(a){var b=a.getAttribute("value");return null!=b?b:L(a.innerText||a.textContent)},select:function(a){for(var b,c=a.options,g=a.selectedIndex,f=(a="select-one"===a.type||0>g)?null:[],d=a?g+1:c.length,t,m=0>g?d:a?g:0;m<d;m++)if(b=c[m],t=b.disabled||null!==b.getAttribute("disabled")||b.parentNode.disabled,(b.selected||m===g)&&!t){b=R(b);if(a)return b;f.push(b)}return f},radio:function(a){return null===
a.getAttribute("value")?"on":a.value},checkbox:function(a){return null===a.getAttribute("value")?"on":a.value}};return function(a){var h,c;if((h=b[a.type]||b[a.nodeName.toLowerCase()])&&void 0!==(c=h(a,"value")))return c;c=a.value;return"string"===typeof c?c.replace(r,""):null==c?"":c}}(),G=Array.prototype.slice,V=MetaphorJs.isPlainObject=function(r){return!(!r||r.constructor!==Object)},s=MetaphorJs.extend=function b(){var a=!1,h=!1,c=G.call(arguments),g=c.shift(),f,d,t;"boolean"==typeof c[c.length-
1]&&(a=c.pop());"boolean"==typeof c[c.length-1]&&(h=a,a=c.pop());for(;c.length;)if(f=c.shift())for(d in f)if(f.hasOwnProperty(d)&&"undefined"!=typeof(t=f[d]))if(h)if(g[d]&&V(g[d])&&V(t))b(g[d],t,a,h);else{if(!0===a||"undefined"==typeof g[d]||null===g[d])V(t)?(g[d]={},b(g[d],t,a,!0)):g[d]=t}else if(!0===a||"undefined"==typeof g[d]||null===g[d])g[d]=t;return g},fa=Object.prototype.toString,ba=MetaphorJs.isArray=function(b){return!(!b||"object"!=typeof b||"number"!=typeof b.length||"[object Array]"!=
fa.call(b))},L=MetaphorJs.trim=function(){return String.prototype.trim?function(b){return"string"==typeof b?b.trim():b}:function(b){return"string"==typeof b?b.replace(/^\s\s*/,"").replace(/\s\s*$/,""):b}}(),r=MetaphorJs.bind=Function.prototype.bind?function(b,a){return b.bind(a)}:function(b,a){return function(){return b.apply(a,arguments)}},x=MetaphorJs.addListener=function(b,a,h){b.attachEvent?b.attachEvent("on"+a,h):b.addEventListener(a,h,!1)},W=MetaphorJs.removeListener=function(b,a,h){b.detachEvent?
b.detachEvent("on"+a,h):b.removeEventListener(a,h,!1)},ca=function(){var b={};return function(a){return b[a]||(b[a]=new RegExp(a))}}(),ga=MetaphorJs.hasClass=function(b,a){return a?ca("(?:^|\\s)"+a+"(?!\\S)").test(b.className):!1},H=MetaphorJs.addClass=function(b,a){a&&!ga(b,a)&&(b.className+=" "+a)},I=MetaphorJs.removeClass=function(b,a){a&&(b.className=b.className.replace(ca("(?:^|\\s)"+a+"(?!\\S)"),""))},U=MetaphorJs.toArray=function(b){if(b&&void 0!=b.length&&"string"!=typeof b){for(var a=[],
h=-1,c=b.length>>>0;++h!==c;a[h]=b[h]);return a}return b?[b]:[]},X=MetaphorJs.select=function(){var b=/^[\w[:#.][\w\]*^|=!]*$/,a=/=([^\]]+)/,h=/ *, */,c=/(\([^)]*)\+/,g=/(\[[^\]]+)~/,f=/(~|>|\+)/,d=/ +/,t=/([^[:.#]+)?(?:#([^[:.#]+))?(?:\.([^[:.]+))?(?:\[([^!&^*|$[:=]+)([!$^*|&]?=)?([^:\]]+)?\])?(?::([^(]+)(?:\(([^)]+)\))?)?/,m=/(?:(-?\d*)n)?(?:(%|-)(\d*))?/,J=/\D/,ha=/[^(]*\(([^)]*)\)/,ia=/\(.*/,r=/\[([^!~^*|$ [:=]+)([$^*|]?=)?([^ :\]]+)?\]/,l=document,e=!!l.getElementsByClassName,k=!!l.querySelectorAll,
n={"first-child":function(e){return e.parentNode.getElementsByTagName("*")[0]!==e},"last-child":function(e){for(;(e=e.nextSibling)&&1!=e.nodeType;);return!!e},root:function(e){return"html"!==e.nodeName.toLowerCase()},"nth-child":function(e,k){var n=e.nodeIndex||0,c=k[3]=k[3]?("%"===k[2]?-1:1)*k[3]:0,a=k[1];if(n)return!((n+c)%a);var g=e.parentNode.firstChild;n++;do if(1==g.nodeType&&(g.nodeIndex=++n)&&e===g&&(n+c)%a)return 0;while(g=g.nextSibling);return 1},"nth-last-child":function(e,k){var n=e.nodeIndexLast||
0,c=k[3]?("%"===k[2]?-1:1)*k[3]:0,a=k[1];if(n)return!((n+c)%a);var g=e.parentNode.lastChild;n++;do if(1==g.nodeType&&(g.nodeLastIndex=n++)&&e===g&&(n+c)%a)return 0;while(g=g.previousSibling);return 1},empty:function(e){return!!e.firstChild},parent:function(e){return!e.firstChild},"only-child":function(e){return 1!=e.parentNode.getElementsByTagName("*").length},checked:function(e){return!e.checked},lang:function(e,k){return e.lang!==k&&l.documentElement.lang!==k},enabled:function(e){return e.disabled||
"hidden"===e.type},disabled:function(e){return!e.disabled},selected:function(e){return!e.selected}},A={},E=function(e){return A[e]||(A[e]=new RegExp("(^| +)"+e+"($| +)"))},z={"":function(e,k){return!!e.getAttribute(k)},"=":function(e,k,n){return(k=e.getAttribute(k))&&k===n},"&=":function(e,k,n){return(k=e.getAttribute(k))&&E(n).test(k)},"^=":function(e,k,n){return(k=e.getAttribute(k)+"")&&!k.indexOf(n)},"$=":function(e,k,n){return(k=e.getAttribute(k)+"")&&k.indexOf(n)==k.length-n.length},"*=":function(e,
k,n){return(k=e.getAttribute(k)+"")&&-1!=k.indexOf(n)},"|=":function(e,k,n){return(k=e.getAttribute(k)+"")&&(k===n||!!k.indexOf(n+"-"))},"!=":function(e,k,n){return!(k=e.getAttribute(k))||!E(n).test(k)}};return function(A,E){E=E||l;var p=[],w=null,y,D,s,q,x,B,C;if(k)try{p=U(E.querySelectorAll(A.replace(a,'="$1"')))}catch(I){w=!0}if(!k||w)if(b.test(A))switch(w=0,A.charAt(0)){case "#":w=A.slice(1);p=l.getElementById(w);p.id!==w&&(p=l.all[w]);p=p?[p]:[];break;case ".":y=A.slice(1);if(e)p=U((p=E.getElementsByClassName(y)).length?
p:[]);else{y=" "+y+" ";D=E.getElementsByTagName("*");for(s=0;q=D[s++];)-1!=(" "+q.className+" ").indexOf(y)&&(p[w++]=q);p=w?p:[]}break;case ":":D=E.getElementsByTagName("*");s=0;x=A.replace(ha,"$1");for(B=A.replace(ia,"");q=D[s++];)n[B]&&!n[B](q,x)&&(p[w++]=q);p=w?p:[];break;case "[":D=E.getElementsByTagName("*");s=0;q=r.exec(A);y=q[1];C=q[2]||"";for(x=q[3];q=D[s++];)z[C]&&(z[C](q,y,x)||"class"===y&&z[C](q,"className",x))&&(p[w++]=q);p=w?p:[];break;default:p=U((p=E.getElementsByTagName(A)).length?
p:[])}else{for(var H=A.split(h),L=H.length-1,R=!!L,G,F,v,K,M,N,O,P,S,u,T,Q;w=H[L--];){F=(G=w.replace(c,"$1%").replace(g,"$1&").replace(f," $1 ").split(d)).length;s=0;K=" ";for(D=[E];v=G[s++];)if(" "!==v&&">"!==v&&"~"!==v&&"+"!==v&&D){v=v.match(t);M=v[1]||"*";N=v[2];O=v[3]?" "+v[3]+" ":"";y=v[4];C=v[5]||"";B=v[7];x="nth-child"===B||"nth-last-child"===B?m.exec("even"===v[8]&&"2n"||"odd"===v[8]&&"2n%1"||!J.test(v[8])&&"0n%"+v[8]||v[8]):v[8];P=[];w=S=0;for(T=s==F;u=D[S++];)switch(K){case " ":Q=u.getElementsByTagName(M);
for(u=0;q=Q[u++];)N&&q.id!==N||O&&-1==(" "+q.className+" ").indexOf(O)||!(!y||z[C]&&(z[C](q,y,v[6])||"class"===y&&z[C](q,"className",v[6])))||q.yeasss||(n[B]?n[B](q,x):B)||(T&&(q.yeasss=1),P[w++]=q);break;case "~":for(M=M.toLowerCase();(u=u.nextSibling)&&!u.yeasss;)1!=u.nodeType||"*"!==M&&u.nodeName.toLowerCase()!==M||N&&u.id!==N||O&&-1==(" "+u.className+" ").indexOf(O)||!(!y||z[C]&&(z[C](q,y,v[6])||"class"===y&&z[C](q,"className",v[6])))||u.yeasss||(n[B]?n[B](u,x):B)||(T&&(u.yeasss=1),P[w++]=u);
break;case "+":for(;(u=u.nextSibling)&&1!=u.nodeType;);!u||u.nodeName.toLowerCase()!==M.toLowerCase()&&"*"!==M||N&&u.id!==N||O&&-1==(" "+q.className+" ").indexOf(O)||!(!y||z[C]&&(z[C](q,y,v[6])||"class"===y&&z[C](q,"className",v[6])))||u.yeasss||(n[B]?n[B](u,x):B)||(T&&(u.yeasss=1),P[w++]=u);break;case ">":for(Q=u.getElementsByTagName(M),s=0;q=Q[s++];)q.parentNode!==u||N&&q.id!==N||O&&-1==(" "+q.className+" ").indexOf(O)||!(!y||z[C]&&(z[C](q,y,v[6])||"class"===y&&z[C](q,"className",v[6])))||q.yeasss||
(n[B]?n[B](q,x):B)||(T&&(q.yeasss=1),P[w++]=q)}D=P}else K=v;if(R){if(!D.concat){P=[];for(u=0;q=D[u];)P[u++]=q;D=P}p=D.concat(1==p.length?p[0]:p)}else p=D}for(w=p.length;w--;)p[w].yeasss=p[w].nodeIndex=p[w].nodeIndexLast=null}return p}}(),Y=function(b,a,h){var c,g=b.childNodes;if(!1!==a.call(h,b))for(b=-1,c=g.length>>>0;++b!==c;Y(g[b],a,h));},K=MetaphorJs.returnFalse=function(){return!1},S=MetaphorJs.returnTrue=function(){return!0};(function(){var b=function(a){if(a instanceof b)return a;if(!(this instanceof
b))return new b(a);for(var h in a)if(!this[h])try{this[h]=a[h]}catch(c){}this.originalEvent=a;this.type=a.type;!this.target&&a.srcElement&&(this.target=a.srcElement);var g,f=a.button;"undefined"==typeof this.pageX&&null!=a.clientX&&(g=this.target?this.target.ownerDocument||document:document,h=g.documentElement,g=g.body,this.pageX=a.clientX+(h&&h.scrollLeft||g&&g.scrollLeft||0)-(h&&h.clientLeft||g&&g.clientLeft||0),this.pageY=a.clientY+(h&&h.scrollTop||g&&g.scrollTop||0)-(h&&h.clientTop||g&&g.clientTop||
0));this.which||void 0===f||(this.which=f&1?1:f&2?3:f&4?2:0);this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&!1===a.returnValue?S:K;this.timeStamp=a&&a.timeStamp||(new Date).getTime()};b.prototype={isDefaultPrevented:K,isPropagationStopped:K,isImmediatePropagationStopped:K,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=S;a.returnValue=!1;a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=
S;a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=S;a&&a.stopImmediatePropagation&&a.stopImmediatePropagation();this.stopPropagation()}};MetaphorJs.lib.NormalizedEvent=b})();var Q=MetaphorJs.normalizeEvent=function(){var b=MetaphorJs.lib.NormalizedEvent;return function(a){return new b(a)}}(),ja=Array.prototype.indexOf,da=MetaphorJs.inArray=function(b,a){return a?-1!=ja.call(a,b):!1},ka=MetaphorJs.setValue=function(){var b=
{select:function(a,b){for(var c,g,f=a.options,d=U(b),t=f.length,m=-1;t--;)g=f[t],(g.selected=da(g.value,d))?c=!0:null!==g.getAttribute("mjs-default-option")&&(m=t);c||(a.selectedIndex=m);return d}};b.radio=b.checkbox=function(a,b){if(ba(b))return a.checked=da(R(a),b)};return function(a,h){if(1===a.nodeType){null===h?h="":"number"===typeof h&&(h+="");var c=b[a.type]||b[a.nodeName.toLowerCase()];c&&void 0!==c(a,h,"value")||(a.value=h)}}}(),la=MetaphorJs.isSubmittable=function(b){var a=b.type?b.type.toLowerCase():
"";return"input"==b.nodeName.toLowerCase()&&"radio"!=a&&"checkbox"!=a},Z=navigator.userAgent.toLowerCase(),ma=function(){var b=parseInt((/android (\d+)/.exec(Z)||[])[1],10)||!1;return function(){return b}}(),na=function(){var b=parseInt((/msie (\d+)/.exec(Z)||[])[1],10);isNaN(b)&&(b=parseInt((/trident\/.*; rv:(\d+)/.exec(Z)||[])[1],10)||!1);return function(){return b}}(),ea=function(){var b={};return function(a){if(void 0===b[a]){if("input"==a&&9==na())return b[a]=!1;var h=document.createElement("div");
b[a]=!!("on"+a in h)}return b[a]}}();(function(){var b=function(a,b,c,g){this.el=a;this.cb=b;this.scb=g;this.cbContext=c;this.inputType=b=a.getAttribute("mjs-input-type")||a.type.toLowerCase();this.listeners=[];this.submittable=la(a);"radio"==b?this.initRadioInput():"checkbox"==b?this.initCheckboxInput():this.initTextInput()};b.prototype={el:null,inputType:null,cb:null,scb:null,cbContext:null,listeners:[],radio:null,submittable:!1,destroy:function(){var a=this.inputType,b=this.listeners,c=this.radio,
g=this.el,f,d,t,m;f=0;for(d=b.length;f<d;f++)if("radio"==a)for(t=0,m=c.length;t<m;t++)W(c[t],b[f][0],b[f][1]);else W(g,b[f][0],b[f][1]);delete this.radio;delete this.el;delete this.cb;delete this.cbContext},initRadioInput:function(){var a=this.el,b=a.type,a=a.name,c,g,f;this.onRadioInputChangeDelegate=r(this.onRadioInputChange,this);if(document.querySelectorAll)c=document.querySelectorAll("input[name="+a+"]");else{var d=document.getElementsByTagName("input"),t;c=[];g=0;for(f=d.length;g<f;g++)t=d[g],
t.type==b&&t.name==a&&c.push(t)}this.radio=c;this.listeners.push(["click",this.onRadioInputChangeDelegate]);g=0;for(f=c.length;g<f;g++)x(c[g],"click",this.onRadioInputChangeDelegate)},initCheckboxInput:function(){this.onCheckboxInputChangeDelegate=r(this.onCheckboxInputChange,this);this.listeners.push(["click",this.onCheckboxInputChangeDelegate]);x(this.el,"click",this.onCheckboxInputChangeDelegate)},initTextInput:function(){var a=!1,b=this,c=b.el,g=b.listeners,f;if(!ma()){var d=function(){a=!0},
t=function(){a=!1;m()};g.push(["compositionstart",d]);g.push(["compositionend",t]);x(c,"compositionstart",d);x(c,"compositionend",t)}var m=b.onTextInputChangeDelegate=function(){if(!a)b.onTextInputChange()};if(ea("input"))g.push(["input",m]),x(c,"input",m);else{var J=function(c){f||(f=window.setTimeout(function(){m(c);f=null},0))},d=function(c){c=c||window.event;var a=c.keyCode;if(13==a&&b.submittable&&b.scb)return b.scb.call(b.cbContext,c);91===a||15<a&&19>a||37<=a&&40>=a||J(c)};g.push(["keydown",
d]);x(c,"keydown",d);ea("paste")&&(g.push(["paste",J]),g.push(["cut",J]),x(c,"paste",J),x(c,"cut",J))}g.push(["change",m]);x(c,"change",m)},processValue:function(a){switch(this.inputType){case "number":a=parseInt(a,10)}return a},onTextInputChange:function(){var a=this.getValue();this.cb.call(this.cbContext,a)},onCheckboxInputChange:function(){var a=this.el;this.cb.call(this.cbContext,a.checked?a.getAttribute("value")||!0:!1)},onRadioInputChange:function(a){a=a||window.event;this.cb.call(this.cbContext,
(a.target||a.srcElement).value)},setValue:function(a){var b=this.inputType,c,g;if("radio"==b)for(b=this.radio,c=0,g=b.length;c<g;c++){if(b[c].value==a){b[c].checked=!0;break}}else"checkbox"==b?(b=this.el,b.checked=!0===a||a==b.value):ka(this.el,a)},getValue:function(){var a=this.inputType,b,c;if("radio"==a){a=this.radio;b=0;for(c=a.length;b<c;b++)if(a[b].checked)return a[b].value;return null}return"checkbox"==a?this.el.checked?this.el.getAttribute("value")||!0:!1:this.processValue(R(this.el))}};MetaphorJs.lib.Input=
b})();var oa=MetaphorJs.lib.Input,F=MetaphorJs.isThenable=function(b){var a;return!b||"object"!=typeof b&&"function"!=typeof b?!1:"function"==typeof(a=b.then)?a:!1};(function(){var b=[],a=!1,h="undefined"!=typeof process?process.nextTick:function(c){setTimeout(c,0)},c=function(){a=!0;var g=b.shift();h(function(){g[0].apply(g[1],g[2]);b.length?c():a=!1},0)},g=function(g,m,d){d=d||[];b.push([g,m,d]);a||c()},f=function(c,a){return function(g){try{a.resolve(c(g))}catch(b){a.reject(b)}}},d=function(c,
a){if(c instanceof d)return c;if(!(this instanceof d))return new d(c,a);this._fulfills=[];this._rejects=[];this._dones=[];this._fails=[];if("undefined"!=typeof c)if(F(c)||"function"!=typeof c)this.resolve(c);else try{c.call(a,r(this.resolve,this),r(this.reject,this))}catch(g){this.reject(g)}};d.prototype={_state:0,_fulfills:null,_rejects:null,_dones:null,_fails:null,_wait:0,_value:null,_reason:null,_triggered:!1,isPending:function(){return 0==this._state},isFulfilled:function(){return 1==this._state},
isRejected:function(){return 2==this._state},_cleanup:function(){delete this._fulfills;delete this._rejects;delete this._dones;delete this._fails},_processValue:function(c,a){var g;if(0==this._state)if(c===this)this._doReject(new TypeError("cannot resolve promise with itself"));else{try{if(g=F(c)){c instanceof d?c.then(r(this._processResolveValue,this),r(this._processRejectReason,this)):(new d(g,c)).then(r(this._processResolveValue,this),r(this._processRejectReason,this));return}}catch(b){0==this._state&&
this._doReject(b);return}a.call(this,c)}},_callResolveHandlers:function(){this._done();for(var c=this._fulfills,a;a=c.shift();)g(a[0],a[1],[this._value]);this._cleanup()},_doResolve:function(c){this._value=c;this._state=1;0==this._wait&&this._callResolveHandlers()},_processResolveValue:function(c){this._processValue(c,this._doResolve)},resolve:function(c){if(this._triggered)return this;this._triggered=!0;this._processResolveValue(c);return this},_callRejectHandlers:function(){this._fail();for(var c=
this._rejects,a;a=c.shift();)g(a[0],a[1],[this._reason]);this._cleanup()},_doReject:function(c){this._state=2;this._reason=c;0==this._wait&&this._callRejectHandlers()},_processRejectReason:function(c){this._processValue(c,this._doReject)},reject:function(c){if(this._triggered)return this;this._triggered=!0;this._processRejectReason(c);return this},then:function(c,a){var b=new d,h=this._state;0==h||0!=this._wait?(c&&"function"==typeof c?this._fulfills.push([f(c,b),null]):this._fulfills.push([b.resolve,
b]),a&&"function"==typeof a?this._rejects.push([f(a,b),null]):this._rejects.push([b.reject,b])):1==h?c&&"function"==typeof c?g(f(c,b),null,[this._value]):b.resolve(this._value):2==h&&(a&&"function"==typeof a?g(f(a,b),null,[this._reason]):b.reject(this._reason));return b},"catch":function(c){return this.then(null,c)},_done:function(){for(var c=this._dones,a;a=c.shift();)a[0].call(a[1]||null,this._value)},done:function(c,a){var b=this._state;1==b&&0==this._wait?c.call(a||null,this._value):0==b&&this._dones.push([c,
a]);return this},_fail:function(){for(var c=this._fails,a;a=c.shift();)a[0].call(a[1]||null,this._reason)},fail:function(c,a){var b=this._state;2==b&&0==this._wait?c.call(a||null,this._reason):0==b&&this._fails.push([c,a]);return this},always:function(c,a){this.done(c,a);this.fail(c,a);return this},promise:function(){return{then:r(this.then,this),done:r(this.done,this),fail:r(this.fail,this),always:r(this.always,this)}},after:function(c){var a=this;if(F(c)){a._wait++;var b=function(){a._wait--;0==
a._wait&&0!=a._state&&(1==a._state?a._callResolveHandlers():a._callRejectHandlers())};"function"==typeof c.done?c.done(b):c.then(b)}return a}};d.resolve=function(c){return new d(c)};d.reject=function(c){var a=new d;a.reject(c);return a};d.all=function(c){if(!c.length)return d.resolve(null);var a=new d,b=c.length,g=Array(b),f=b,h,l,e=function(e,c){g[c]=e;f--;0==f&&a.resolve(g)};for(h=0;h<b;h++)(function(k){l=c[h];l instanceof d?l.done(function(c){e(c,k)}).fail(a.reject,a):F(l)||"function"==typeof l?
(new d(l)).done(function(c){e(c,k)}).fail(a.reject,a):e(l,k)})(h);return a};d.when=function(){return d.all(arguments)};d.allResolved=function(c){if(!c.length)return d.resolve(null);var a=new d,b=c.length,g=[],f=b,h,l,e=function(e){g.push(e);k()},k=function(){f--;0==f&&a.resolve(g)};for(h=0;h<b;h++)l=c[h],l instanceof d?l.done(e).fail(k):F(l)||"function"==typeof l?(new d(l)).done(e).fail(k):e(l);return a};d.race=function(c){if(!c.length)return d.resolve(null);var a=new d,b=c.length,g,f;for(g=0;g<b&&
(f=c[g],f instanceof d?f.done(a.resolve,a).fail(a.reject,a):F(f)||"function"==typeof f?(new d(f)).done(a.resolve,a).fail(a.reject,a):a.resolve(f),a.isPending());g++);return a};MetaphorJs.lib.Promise=d})();var $=MetaphorJs.lib.Promise,pa=MetaphorJs.nextUid=function(){var b=["0","0","0"];return function(){for(var a=b.length,h;a;){a--;h=b[a].charCodeAt(0);if(57==h)return b[a]="A",b.join("");if(90==h)b[a]="0";else return b[a]=String.fromCharCode(h+1),b.join("")}b.unshift("0");return b.join("")}}(),qa=
MetaphorJs.async=function(b,a,h){setTimeout(function(){b.apply(a,h||[])},0)};(function(){var b=function(){this.events={}};b.prototype={createEvent:function(c,b){c=c.toLowerCase();var f=this.events;f[c]||(f[c]=new a(c,b));return f[c]},getEvent:function(c){c=c.toLowerCase();return this.events[c]},on:function(c,b,f,d){c=c.toLowerCase();var h=this.events;h[c]||(h[c]=new a(c));return h[c].on(b,f,d)},once:function(c,a,b,d){d=d||{};d.limit=1;return this.on(c,a,b,d)},un:function(c,a,b){c=c.toLowerCase();
var d=this.events;d[c]&&d[c].un(a,b)},hasListener:function(c,a,b){c=c.toLowerCase();var d=this.events;return d[c]?d[c].hasListener(a,b):!1},removeAllListeners:function(c){var a=this.events;a[c]&&a[c].removeAllListeners()},triggerAsync:function(){var c=arguments[0],a=this.events,c=c.toLowerCase();if(!a[c])return[];c=a[c];return c.triggerAsync.apply(c,G.call(arguments,1))},trigger:function(){var c=arguments[0],a=this.events,c=c.toLowerCase();if(!a[c])return null;c=a[c];return c.trigger.apply(c,G.call(arguments,
1))},suspendEvent:function(c){c=c.toLowerCase();var a=this.events;a[c]&&a[c].suspend()},suspendAllEvents:function(){var c=this.events,a;for(a in c)c[a].suspend()},resumeEvent:function(c){c=c.toLowerCase();var a=this.events;a[c]&&a[c].resume()},resumeAllEvents:function(){var c=this.events,a;for(a in c)c[a].resume()},destroyEvent:function(c){var a=this.events;a[c]&&(a[c].removeAllListeners(),a[c].destroy(),delete a[c])},destroy:function(c){var a=this.events;if(c)c=c.toLowerCase(),a[c]&&(a[c].destroy(),
delete a[c]);else{for(var b in a)a[b].destroy();this.events={}}},getApi:function(){if(!this.api){for(var a="createEvent getEvent on un once hasListener removeAllListeners triggerAsync trigger suspendEvent suspendAllEvents resumeEvent resumeAllEvents destroyEvent".split(" "),b={},f,d=-1,h=a.length;++d<h;f=a[d],b[f]=r(this[f],this));this.api=b}return this.api}};var a=function(a,b){this.name=a;this.listeners=[];this.map={};this.hash=pa();this.uni="$$"+a+"_"+this.hash;this.suspended=!1;this.lid=0;this.returnResult=
b||!1};a.prototype={getName:function(){return this.name},destroy:function(){this.map=this.listeners=null},on:function(a,b,f){if(!a)return null;b=b||null;f=f||{};var d=this.uni,h=b||a;if(h[d]&&!f.allowDupes)return null;var m=++this.lid,r=f.first||!1;h[d]=m;a={fn:a,scope:b,uniScope:h,id:m,called:0,limit:f.limit||0,start:f.start||1,count:0,append:f.append,prepend:f.prepend};r?this.listeners.unshift(a):this.listeners.push(a);this.map[m]=a;return m},once:function(a,b,f){f=f||{};f.once=!0;return this.on(a,
b,f)},un:function(a,b){var f=-1,d=this.uni,h=this.listeners,m;m=a==parseInt(a)?a:(b||a)[d];if(!m)return!1;for(var r=0,s=h.length;r<s;r++)if(h[r].id==m){f=r;delete h[r].uniScope[d];break}if(-1==f)return!1;h.splice(f,1);delete this.map[m];return!0},hasListener:function(a,b){var f=this.listeners,d;if(a){d="function"!=typeof a?a:(b||a)[this.uni];if(!d)return!1;for(var h=0,m=f.length;h<m;h++)if(f[h].id==d)return!0;return!1}return 0<f.length},removeAllListeners:function(){var a=this.listeners,b=this.uni,
f,d;f=0;for(d=a.length;f<d;f++)delete a[f].uniScope[b];this.listeners=[];this.map={}},suspend:function(){this.suspended=!0},resume:function(){this.suspended=!1},_prepareArgs:function(a,b){var f;a.append||a.prepend?(f=G.call(b),a.prepend&&(f=a.prepend.concat(f)),a.append&&(f=f.concat(a.append))):f=b;return f},triggerAsync:function(){if("undefined"==typeof $)throw Error("Promises are not defined");var a=this,b=a.listeners,f=a.returnResult,d=G.call(arguments),h=[],m=[],r,s,x;if(a.suspended||0==b.length)return $.resolve(null);
s=0;for(x=b.length;s<x;s++)h.push(b[s]);for(s=function(b){r=a._prepareArgs(b,d);return new $(function(g,e){qa(function(){try{g(b.fn.apply(b.scope,r))}catch(k){e(k)}b.called++;b.called==b.limit&&a.un(b.id)},0)})};(b=h.shift())&&(!b||!a.map[b.id]||(b.count++,b.count<b.start||(m.push(s(b)),"first"!=f))););return"last"==f?[m.pop()]:m},trigger:function(){var a=this.listeners,b=this.returnResult;if(this.suspended||0==a.length)return null;for(var f="all"==b?[]:null,d,h,a="first"==b?[a[0]]:G.call(a);d=a.shift();)if(d&&
this.map[d.id]&&(d.count++,!(d.count<d.start))){h=d.fn.apply(d.scope,this._prepareArgs(d,arguments));d.called++;d.called==d.limit&&this.un(d.id);"all"==b&&f.push(h);if("first"==b)return h;"last"==b&&(f=h);if(!1==b&&!1===h)break}if(b)return f}};var h=new b;s(MetaphorJs,h.getApi(),!0,!1);MetaphorJs.lib.Observable=b})();var aa=MetaphorJs.lib.Observable;(function(){var b=0,a={},h=function(e,a){var n=0;switch(a.nodeName.toLowerCase()){case "select":return Y(a,function(e){e.selected&&n++}),n;case "input":if(/radio|checkbox/i.test(a.type))return Y(a.form,
function(e){e.type==a.type&&e.name==a.name&&e.checked&&n++}),n}return e.length},c=function(e,a){if(!a)return void 0===e||""===e||null===e;switch(a.nodeName.toLowerCase()){case "select":var n=R(a);return!n||0==n.length;case "input":if(/radio|checkbox/i.test(a.type))return 0==h(e,a)}return 0==L(e).length},g=function(e,a){if("function"==typeof a)return e;ba(a)||(a=[a]);var n,b=a.length;for(n=-1;++n<b;e=e.replace(new RegExp("\\{"+n+"\\}","g"),a[n]));return e},f={};s(f,{required:function(e,a,b){return!1===
b?!0:!c(e,a)},regexp:function(e,a,b){b=b instanceof RegExp?b:new RegExp(b);return c(e,a)||b.test(e)},notregexp:function(e,a,b){b=b instanceof RegExp?b:new RegExp(b);return c(e,a)||!b.test(e)},minlength:function(e,a,b){return c(e,a)||(a?h(L(e),a)>=b:e.toString().length>=b)},maxlength:function(e,a,b){return c(e,a)||(a?h(L(e),a)<=b:e.toString().length<=b)},rangelength:function(e,a,b){var A=a?h(L(e),a):e.toString().length;return c(e,a)||A>=b[0]&&A<=b[1]},min:function(e,a,b){return c(e,a)||parseInt(e,
10)>=b},max:function(e,a,b){return c(e,a)||parseInt(e,10)<=b},range:function(e,a,b){e=parseInt(e,10);return c(e,a)||e>=b[0]&&e<=b[1]},email:function(e,a){return c(e,a)||/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test(e)},
url:function(e,a){return c(e,a)||/^((https?|ftp):\/\/|)(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(e)},
date:function(e,a){return c(e,a)||!/Invalid|NaN/.test(new Date(e))},dateiso:function(e,a){return c(e,a)||/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(e)},number:function(e,a){return c(e,a)||/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(e)},digits:function(e,a){return c(e,a)||/^\d+$/.test(e)},creditcard:function(e,a){if(c(e,a))return!0;if(/[^0-9-]+/.test(e))return!1;var b=0,A=!1,d;e=e.replace(/\D/g,"");for(var f=e.length-1;0<=f;f--)d=e.charAt(f),d=parseInt(d,10),A&&9<(d*=2)&&(d-=9),b+=d,A=!A;return 0==
b%10},accept:function(e,a,b){b="string"==typeof b?b.replace(/,/g,"|"):"png|jpe?g|gif";return c(e,a)||e.match(new RegExp(".("+b+")$","i"))},equalto:function(e,a,b,c){b=(a=c.getValidator().getField(b))?a.getElem():b;return e==R(b)},notequalto:function(e,a,b,c){b=(a=c.getValidator().getField(b))?a.getElem():b;return e!=R(b)},zxcvbn:function(e,a,b){return zxcvbn(e).score>=parseInt(b)}});var d={required:"This field is required.",remote:"Please fix this field.",email:"Please enter a valid email address.",
url:"Please enter a valid URL.",date:"Please enter a valid date.",dateISO:"Please enter a valid date (ISO).",number:"Please enter a valid number.",digits:"Please enter only digits.",creditcard:"Please enter a valid credit card number.",equalTo:"Please enter the same value again.",accept:"Please enter a value with a valid extension.",maxlength:"Please enter no more than {0} characters.",minlength:"Please enter at least {0} characters.",rangelength:"Please enter a value between {0} and {1} characters long.",
range:"Please enter a value between {0} and {1}.",max:"Please enter a value less than or equal to {0}.",min:"Please enter a value greater than or equal to {0}."},t={allowSubmit:!0,alwaysCheck:!1,alwaysDisplayState:!1,data:null,ignore:null,disabled:!1,cls:{valid:"",error:"",ajax:""},errorBox:{cls:"",fn:null,tag:"",position:"after",elem:null,enabled:!0},callback:{scope:null,destroy:null,statechange:null,errorchange:null,submit:null,check:null,beforeAjax:null,afterAjax:null,displaystate:null},rules:{},
messages:{}},m=function(e){if(!e)return{};var a=function(a,b,k){var c=e[a],d=!1;if(void 0!==c){switch(k){case "string":d="string"==typeof c;break;case "function":d="function"==typeof c;break;case "boolean":if(!0===c||!1===c)d=!0}d&&(e[a]={},e[a][b]=c)}};a("errorBox","enabled","boolean");a("errorBox","tag","string");a("errorBox","fn","function");return e},J=function(e,a,b){a=a||{};var c,f;this._observable=new aa;s(this,this._observable.getApi());this.cfg=c=s({},t,m(l.fieldDefaults),m(a),!0,!0);this.input=
new oa(e,this.onInputChange,this,this.onInputSubmit);this.elem=e;this.vldr=b;this.callbackScope=f=c.callback.scope;this.enabled=!e.disabled;this.id=e.getAttribute("name")||e.getAttribute.attr("id");this.data=a.data;this.rules={};c.messages=s({},d,l.messages,c.messages,!0,!0);e.setAttribute("data-validator",b.getVldId());this.input.radio&&this.initRadio();for(var g in c.callback)if(c.callback[g])this.on(g,c.callback[g],f);c.rules&&this.setRules(c.rules,!1);this.readRules();this.prev=this.input.getValue();
c.disabled&&this.disable()};J.prototype={vldr:null,elem:null,rules:null,cfg:null,callbackScope:null,input:null,enabled:!0,valid:null,dirty:!1,id:null,prev:"",error:null,errorRule:null,pending:null,rulesNum:0,displayState:!1,data:null,checking:!1,checkTmt:null,errorBox:null,customError:!1,getValidator:function(){return this.vldr},initRadio:function(){var e=this.input.radio,a=this.vldr.getVldId(),b,c;b=0;for(c=e.length;b<c;b++)e[b].setAttribute("data-validator",a)},setRules:function(e,a){a=void 0==
a?!0:a;for(var b in e)this.setRule(b,e[b],!1);a?this.check(!1):this.setValidState(null);return this},setRule:function(e,a,b){var c=this.rules;b=void 0==b?!0:b;null===a?(c[e]&&this.rulesNum--,delete c[e]):(c[e]||this.rulesNum++,c[e]=a,null!==this.valid&&this.setValidState(!1));b?this.check(!1):this.setValidState(null);return this},setMessage:function(e,a){this.cfg.messages[e]=a;return this},setMessages:function(e){for(var a in e)this.setMessage(a,e[a]);return this},getMessages:function(){return s({},
this.cfg.messages)},readRules:function(){var e=this.elem,a=e.className,b={},c,d;for(d in f)f.hasOwnProperty(d)&&(c=e.getAttribute(d)||e.getAttribute("data-validate-"+d),null!==c&&void 0!=c&&!1!==c&&("minlength"!=d&&"maxlength"!=d||-1!=parseInt(c,10))&&(b[d]=c,(c=e.getAttribute("data-message-"+d))&&this.setMessage(d,c)));if(c=e.getAttribute("remote"))b.remote=c;if(a)for(a=a.split(" "),d=0,c=a.length;d<c;d++)if(e=L(a[d]),f[e]||"remote"==e)b[e]=!0;for(d in b)this.setRule(d,b[d],!1)},getRules:function(){return this.rules},
hasRule:function(a){return this.rules[a]?!0:!1},getValue:function(){return this.input.getValue()},getUserData:function(){return this.data},setUserData:function(a){var b=this.data;this.data=a;return b},isEmpty:function(){return c(this.getValue(),this.elem)},enable:function(){this.enabled=!0;this.vldr.reset();return this},disable:function(){this.enabled=!1;!1===this.valid&&(this.setValidState(!0),this.doDisplayState());return this},enableDisplayState:function(){this.displayState=!0},disableDisplayState:function(){this.displayState=
!1},isDisplayStateEnabled:function(){return this.displayState},toggleErrorBox:function(a){var b=this.cfg,c=b.errorBox.enabled;b.errorBox.enabled=a;!c&&a&&a.displayState&&!1===this.valid()&&this.doDisplayState()},isEnabled:function(){return this.enabled},getElem:function(){return this.elem},getName:function(){return this.id},getError:function(){return this.error},getErrorRule:function(){return this.errorRule},isValid:function(){return this.isEnabled()?this.customError?!1:!0===this.valid&&!this.pending||
0===this.rulesNum:!0},getExactValidState:function(){return this.valid},setCustomError:function(a,b){this.customError=a?!0:!1;this.setValidState(a?!1:!0);this.setError(!0===a?null:a,b);this.doDisplayState()},reset:function(){this.abort();this.dirty=!1;this.prev="";this.setValidState(null);this.setError(null);this.doDisplayState();return this},abort:function(){this.pending&&(this.pending.abort(),this.pending=null);return this},check:function(a){var b=this.rules,c=this.cfg,d=this.elem;if(!this.isEnabled())return!0;
if(this.customError)return!1;if(0==this.rulesNum&&!1!==this.valid)return!0;if(this.checking)return this.checkTmt||(this.checkTmt=setTimeout(r(this.checkTimeout,this),100)),!0===this.valid;this.checking=!0;if(!(!0===a||b.equalTo||b.notEqualTo||this.dirty||null===this.valid||c.alwaysCheck))return this.pending||this.doDisplayState(),this.checking=!1,!0===this.valid;var h=!0,z=!1,m=this.getValue(),l,p;for(p in b)if("remote"==p){if(this.dirty||c.alwaysCheck||null===this.valid||!0===a)if(m||b[p].checkEmpty)z=
!0}else if(!0!==(l=("function"==typeof b[p]?b[p]:f[p]).call(this.callbackScope,m,d,b[p],this))){h=!1;this.setError(g(l||c.messages[p]||"",b[p]),p);break}z=z&&h;h&&this.setError(null);z?this.ajaxCheck():(this.setValidState(h),this.doDisplayState());this.checking=this.dirty=!1;this.trigger("check",this,this.valid);return!0===this.valid&&!z},doDisplayState:function(){var a=this.cfg,b=this.isValid(),c=a.cls.error,d=a.cls.valid,f=this.elem;this.displayState||a.alwaysDisplayState||(b=null);null===this.valid&&
(b=null);c&&(!1===b?H(f,c):I(f,c));d&&(!0===b?H(f,d):I(f,d));c=this.getErrorBox();d=this.error;c&&(!1===b&&d&&(c.innerHTML=state.error),c.style.display=!1===b&&d&&a.errorBox.enabled?"block":"none");this.trigger("displaystate",this,b,this.error)},getErrorBox:function(){var a=this.cfg.errorBox;return a.tag||a.fn||a.selector?(!this.errorBox&&a.enabled&&this.createErrorBox(),this.errorBox):null},destroy:function(){this.trigger("destroy",this);this.elem.removeAttribute("data-validator");this.errorBox&&
this.errorBox.parentNode.removeChild(this.errorBox);this.input.destroy();delete this.input;this._observable.destroy();delete this._observable;delete this.vldr;delete this.cfg;delete this.errorBox;delete this.rules;delete this.elem},isPending:function(){return null!==this.pending},setValidState:function(a){this.valid!==a&&(this.valid=a,this.trigger("statechange",this,a))},setError:function(a,b){if(this.error!=a||this.errorRule!=b)this.error=a,this.errorRule=b,this.trigger("errorchange",this,a,b)},
checkTimeout:function(){this.checkTmt=null;this.checking||this.check(!1)},onInputChange:function(a){this.prev!==a&&(this.dirty=!0,this.customError=!1,this.abort(),this.pending||this.check(!1),this.prev=this.input.getValue())},onInputSubmit:function(a){a=Q(a);if(!(a.isDefaultPrevented&&a.isDefaultPrevented()||!1!==this.trigger("submit",this,a)))return a.preventDefault(),!1},createErrorBox:function(){var a=this.cfg.errorBox,b=a.tag,c=a.cls,d=a.fn,f=a.position,a=a.elem;d?this.errorBox=d.call(this.callbackScope,
this):a?this.errorBox=a:(this.errorBox=document.createElement(b),this.errorBox.className=c,b=(b=this.input.radio)?b[b-1]:this.elem,"appendParent"==f?b.parentNode.appendChild(this.errorBox):"before"==f?b.parentNode.insertBefore(this.errorBox,b):b.parentNode.insertBefore(this.errorBox,b.nextSibling))},ajaxCheck:function(){var a=this.elem,b=this.rules.remote,c=this.getValue(),d=this.cfg,b=s({},"string"==typeof b?{url:b}:b,!0);b.data=b.data||{};b.data[b.paramName||a.getAttribute("name")||a.getAttribute("id")]=
c;b.handler||(b.dataType="text");b.cache=!1;d.cls.ajax&&H(a,d.cls.ajax);this.trigger("beforeAjax",this,b);this.pending=(window.MetaphorJs?MetaphorJs.ajax:jQuery.ajax)(b);this.pending.done(r(this.onAjaxSuccess,this));this.pending.fail(r(this.onAjaxError,this))},onAjaxSuccess:function(a){var b=this.rules,c=this.cfg;this.pending=null;var d=!0;b.remote.handler?(a=b.remote.handler.call(this.callbackScope,this,a),!0!==a&&(this.setError(g(a||c.messages.remote||"",b.remote),"remote"),d=!1)):a?(this.setError(a,
"remote"),d=!1):this.setError(null);c.cls.ajax&&I(this.elem,c.cls.ajax);this.setValidState(d);this.doDisplayState();this.trigger("afterAjax",this)},onAjaxError:function(a,b){var c=this.cfg;c.cls.ajax&&I(this.elem,c.cls.ajax);this.pending=null;"abort"!=b&&"abort"!=a&&(this.setValidState(!1),this.doDisplayState(),this.trigger("afterAjax",this))}};var G={alwaysCheck:!1,alwaysDisplayState:!1,disabled:!1,value:null,elem:null,errorBox:null,errorField:null,data:null,cls:{valid:"",error:""},fields:[],rules:{},
messages:{},callback:{scope:null,destroy:null,statechange:null,errorchange:null,displaystate:null}},F=function(a,b){a=a||{};var c,f;this._observable=new aa;this._vldr=b;s(this,this._observable.getApi());this.cfg=c=s({},G,l.groupDefaults,a,!0,!0);this.callbackScope=f=c.callback.scope;this.data=a.data;this.el=a.elem;this.fields={};this.rules={};c.messages=s({},d,l.messages,c.messages,!0,!0);var g;if(c.callback)for(g in c.callback)if(c.callback[g])this.on(g,c.callback[g],f);c.rules&&this.setRules(c.rules,
!1);if(c.fields)for(g=0,f=a.fields.length;g<f;g++)this.add(b.getField(c.fields[g]));this.enabled=!c.disabled};F.prototype={fields:null,rules:null,cfg:null,callbackScope:null,vldr:null,enabled:!1,invalid:null,valid:null,displayState:!1,rulesNum:0,error:null,data:null,errorBox:null,el:null,enable:function(){this.enabled=!0;return this},disable:function(){this.enabled=!1;return this},isEnabled:function(){return this.enabled},isValid:function(){return!this.enabled||0===this.invalid&&!0===this.valid},
getExactValidState:function(){return this.valid},reset:function(){this.invalid=0;this.setValidState(null);this.setError(null);this.doDisplayState();return this},getUserData:function(){return this.data},getName:function(){return this.cfg.name},setRules:function(a,b){b=void 0==b?!0:b;for(var c in a)this.setRule(c,a[c],!1);b?this.check():this.setValidState(null);return this},setRule:function(a,b,c){var d=this.rules;c=void 0==c?!0:c;null===b?(d[a]&&this.rulesNum--,delete d[a]):(d[a]||this.rulesNum++,
d[a]=b,null!==this.valid&&this.setValidState(!1));c?this.check():this.setValidState(null);return this},getRules:function(){return s({},this.rules)},hasRule:function(a){return this.rules[a]?!0:!1},setError:function(a){var b=this.cfg;this.error!=a&&(b.errorField?(this.vldr.getField(b.errorField).setError(a),this.error=null):(this.error=a,this.trigger("errorchange",this,a)))},getError:function(){return this.error},getFields:function(){return this.fields},enableDisplayState:function(){this.displayState=
!0;return this},disableDisplayState:function(){this.displayState=!1;return this},check:function(){var a=this.cfg,b=this.fields,c=this.rules;if(!this.enabled||0==this.rulesNum)return this.setValidState(null),this.doDisplayState(),!0;this.countInvalid();if(0<this.invalid)return this.setValidState(null),this.doDisplayState(),!0;var d={},h=!0,m=null,l;if(a.value){for(l in b)d[l]=b[l].getValue();m=a.value.call(this.callbackScope,d,this)}for(l in c)if(!0!==(b=("function"==typeof c[l]?c[l]:f[l]).call(this.callbackScope,
m,null,c[l],this,d))){h=!1;b||a.messages[l]?this.setError(g(b||a.messages[l]||"",c[l])):this.setError(null);break}h&&this.setError(null);this.setValidState(h);this.doDisplayState();return!0===this.valid},doDisplayState:function(){var a=this.valid,b=this.cfg;this.displayState||b.alwaysDisplayState||(a=null);if(b.errorBox){var c=this.getErrorBox();null!==a?c&&(c.innerHTML=this.error||"",c.style.display=!1===this.valid?"block":"none"):c&&(c.style.display="none")}c=b.cls.error;b=b.cls.valid;a=this.valid;
c&&(!1===a?H(this.el,c):I(this.el,c));b&&(!0===a?H(this.el,b):I(this.el,b));this.trigger("displaystate",this,this.valid)},getErrorBox:function(){var a=this.cfg,b=this.fields,c=a.errorBox;if(b[c])return b[c].getErrorBox();this.errorBox||(this.errorBox="function"==typeof a.errorBox?a.errorBox.call(this.callbackScope,this):a.errorBox);return this.errorBox},destroy:function(){var a=this.fields,b;for(b in a)a[b]&&(this.setFieldEvents(a[b],"un"),delete a[b]);this.errorBox&&this.errorBox.parentNode.removeChild(this.errorBox);
this._observable.destroy();delete this._observable;delete this.vldr;delete this.rules;delete this.fields;delete this.cfg},add:function(a){var b=this.fields,c=a.getName();b[c]||(b[c]=a,this.setFieldEvents(a,"on"))},setFieldEvents:function(a,b){a[b]("statechange",this.onFieldStateChange,this)},remove:function(a){var b=this.fields,c=a.getName();b[c]&&(delete b[c],this.setFieldEvents(a,"un"));return this},setValidState:function(a){this.valid!==a&&(this.valid=a,this.trigger("statechange",this,a))},countInvalid:function(){var a=
this.fields;this.invalid=0;for(var b in a)this.invalid+=a[b].isValid()?0:1},onFieldStateChange:function(a,b){this.trigger("fieldstatechange",this,a,b);this.check()}};var K={form:null,all:{},fields:{},rules:{},cls:{valid:"",error:"",checking:""},groups:{},callback:{scope:null,destroy:null,reset:null,beforesubmit:null,submit:null,statechange:null,check:null,displaystate:null,displaystatechange:null}},l=function(c,d,f){var g=c.nodeName.toLowerCase();this.vldId=++b;a[this.vldId]=this;c.setAttribute("data-validator",
this.vldId);this.el=c;d&&"string"!=typeof d&&(f=d,d=null);this._observable=new aa;this.cfg=c=s({},K,l.defaults,l[d],f,!0,!0);this.callbackScope=d=c.callback.scope;this.isForm="form"==g;this.isField=/input|select|textarea/.test(g);this.fields={};this.groups={};s(this,this._observable.getApi());this.onRealSubmitClickDelegate=r(this.onRealSubmitClick,this);this.resetDelegate=r(this.reset,this);this.onSubmitClickDelegate=r(this.onSubmitClick,this);this.onFormSubmitDelegate=r(this.onFormSubmit,this);delete c.callback.scope;
var h,m;for(m in c.callback)this.on(m,c.callback[m],d);this.initFields();g=this.fields;for(h in c.rules)g[h]&&g[h].setRules(c.rules[h],!1);c.rules=null;for(h in c.groups)this.addGroup(h,c.groups[h]);this.initForm("bind");delete c.rules;delete c.fields;delete c.groups;this.enabled=!0};l.prototype={vldId:null,el:null,cfg:null,enabled:!1,invalid:null,pending:0,grps:0,outside:!0,submitted:!1,displayState:!1,isForm:!1,isField:!1,submitButton:null,hidden:null,callbackScope:null,_observable:null,fields:null,
groups:null,getVldId:function(){return this.vldId},getElem:function(){return this.el},getGroup:function(a){return this.groups[a]||null},getField:function(a){return this.fields[a]||null},enable:function(){this.enabled=!0;return this},disable:function(){this.enabled=!1;return this},isEnabled:function(){return this.enabled},enableDisplayState:function(){var a=this.fields,b=this.groups,c;if(!0!==this.displayState){this.displayState=!0;for(c in a)a[c].enableDisplayState();for(c in b)b[c].enableDisplayState();
this.trigger("displaystatechange",this,!0)}return this},disableDisplayState:function(){var a=this.groups,b=this.fields,c;if(!1!==this.displayState){this.displayState=!1;for(c in b)b[c].disableDisplayState();for(c in a)a[c].disableDisplayState();this.trigger("displaystatechange",this,!1)}return this},isDisplayStateEnabled:function(){return this.displayState},isValid:function(){return!1===this.enabled?!0:0===this.invalid&&0===this.pending&&0===this.grps&&!0===this.outside},getErrors:function(a){var b=
!0==a?[]:{},c,d,f,g=[this.fields,this.groups],h;if(!this.isEnabled())return b;for(f=0;2>f;f++)for(d in h=g[f],h)null===h[d].getExactValidState()&&h[d].check(),h[d].isValid()||(c=h[d].getError())&&(a?b.push(c):b[d]=c);return b},check:function(){var a=this.fields,b=this.groups;if(!this.isEnabled())return!0;var c=this.isValid(),d;for(d in a)a[d].check();for(d in b)b[d].check();this.outside=!1!==this.trigger("check",this);a=this.isValid();c!=a&&(this.doDisplayState(),this.trigger("statechange",this,!1));
return a},add:function(a,b){var c=a.nodeName.toLowerCase(),d=a.type;if("input"!=c&&"textarea"!=c&&"select"!=c||"submit"==d||"reset"==d||"button"==d||null!==a.getAttribute("data-no-validate")||null!==a.getAttribute("data-validator"))return this;var d=a.getAttribute("name")||a.getAttribute("id"),f=this.cfg,c=this.fields;if(!d)return this;d=f.fields&&f.fields[d]?f.fields[d]:b||{};"string"==typeof d&&(d={rules:[d]});d=s({},f.all||{},d,!0,!0);if(d.ignore)return this;d.callback||(d.callback={scope:this.callbackScope});
f=new J(a,d,this);d=f.getName();if(c[d])return this;c[d]=f;this.setFieldEvents(f,"on");this.displayState&&f.enableDisplayState();this.isEnabled()&&null!==this.invalid&&f.check();return this},addGroup:function(a,b){var c=this.groups;c[a]||(b.name=a,c[a]=new F(b,this),this.setGroupEvents(c[a],"on"),this.isEnabled()&&null!==this.invalid&&c[a].check())},focusInvalid:function(){var a=this.fields,b;for(b in a)if(!a[b].isValid()){a[b].getElem().focus();break}},reset:function(){var a=this.fields,b=this.groups,
c;this.submitted=!1;this.disableDisplayState();for(c in b)b[c].reset();for(c in a)a[c].reset();this.pending=0;this.invalid=null;this.grps=0;this.outside=!1;this.doDisplayState();this.trigger("reset",this);return this},submit:function(){var a=this.el;if(this.isForm)if("function"==typeof a.submit)!1!==this.trigger("beforesubmit",this)&&!1!==this.trigger("submit",this)&&a.submit();else this.onSubmit();else this.onSubmit()},setFieldEvents:function(a,b){a[b]("statechange",this.onFieldStateChange,this);
a[b]("beforeAjax",this.onBeforeAjax,this);a[b]("afterAjax",this.onAfterAjax,this);a[b]("submit",this.onFieldSubmit,this);a[b]("destroy",this.onFieldDestroy,this)},setGroupEvents:function(a,b){a[b]("statechange",this.onGroupStateChange,this)},initFields:function(){var a=this.el,b,c;if(this.isField)return this.add(a),this;a=X("input, textarea, select",a);b=-1;for(c=a.length;++b<c;this.add(a[b]));return this},initForm:function(a){var b=this.el,c=b.getElementsByTagName("input"),d=X(".submit",b),f=X(".reset",
b);a="bind"==a?x:W;var g,h,l,m;g=0;for(h=c.length;g<h;g++)m=c[g],l=m.type,"submit"==l?a(m,"click",this.onRealSubmitClickDelegate):"reset"==l&&a(m,"click",this.resetDelegate);g=-1;for(h=d.length;++g<h;"submit"!=d[g].type&&a(d[g],"click",this.onSubmitClickDelegate));g=-1;for(h=f.length;++g<h;"reset"!=f[g].type&&a(f[g],"click",this.resetDelegate));this.isForm&&a(b,"submit",this.onFormSubmitDelegate)},onRealSubmitClick:function(a){a=Q(a||window.event);this.submitButton=a.target||a.srcElement;return this.onSubmit(a)},
onSubmitClick:function(a){return this.onSubmit(Q(a||window.event))},onFormSubmit:function(a){a=Q(a);if(!this.isValid())return a.preventDefault(),!1},onFieldSubmit:function(a,b){this.enableDisplayState();this.submitted=!0;return this.onSubmit(b)},onSubmit:function(a){this.enableDisplayState();if(this.pending)return a&&a.preventDefault(),!1;var b=this.submitButton?!0:!1;this.isForm&&(this.hidden&&(this.el.removeChild(this.hidden),this.hidden=null),this.submitButton&&/input|button/.test(this.submitButton.nodeName)&&
(this.hidden=document.createElement("input"),this.hidden.type="hidden",this.hidden.setAttribute("name",this.submitButton.name),this.hidden.value=this.submitButton.value,this.el.appendChild(this.hidden)));this.submitButton=null;if(!this.isValid()&&(this.check(),this.onFieldStateChange(),this.pending))return a&&a.preventDefault(),!1;if(!1===this.trigger("beforesubmit",this)||!this.isValid())return a&&(a.preventDefault(),a.stopPropagation()),this.pending||(this.focusInvalid(),this.submitted=!1),this.trigger("failedsubmit",
this,b),!1;this.pending||(this.submitted=!1);return!1!==this.trigger("submit",this)},onFieldDestroy:function(a){a=a.getElem();a=a.getAttribute("name")||a.getAttribute("id");delete this.fields[a]},onFieldStateChange:function(a,b){var c=this.invalid,d=this.fields;this.invalid=0;for(var f in d)this.invalid+=d[f].isValid()?0:1;a&&this.trigger("fieldstatechange",this,a,b);if(null===c||null!==c&&this.invalid!==c)this.doDisplayState(),this.trigger("statechange",this,this.isValid())},onGroupStateChange:function(){var a=
this.groups,b=this.grps;this.grps=0;for(var c in a)this.grps+=a[c].isValid()?0:1;if(null===b||null!==b&&this.grps!==b)this.doDisplayState(),this.trigger("statechange",this,this.isValid())},doDisplayState:function(){var a=this.cfg,b=this.isValid(),c=a.cls.error,a=a.cls.valid,d=this.el;if(this.isField||!this.displayState)b=null;null===this.invalid&&(b=null);c&&(!1===b?H(d,c):I(d,c));a&&(!0===b?H(d,a):I(d,a));this.trigger("displaystate",this,b)},onBeforeAjax:function(){this.pending++;this.cfg.cls.ajax&&
H(this.el,this.cfg.cls.ajax)},onAfterAjax:function(){var a=this.fields,b=this.cfg;this.pending=0;for(var c in a)this.pending+=a[c].isPending()?1:0;this.doDisplayState();b.cls.ajax&&I(this.el,b.cls.ajax);this.submitted&&0==this.pending&&(this.submitted=!1,this.isValid()?this.submit():this.focusInvalid())},destroy:function(){var b=this.groups,c=this.fields,d;this.reset();this.trigger("destroy",this);delete a[this.vldId];for(d in b)b.hasOwnProperty(d)&&b[d]&&(this.setGroupEvents(b[d],"un"),b[d].destroy(),
delete b[d]);for(d in c)c.hasOwnProperty(d)&&c[d]&&(this.setFieldEvents(c[d],"un"),c[d].destroy(),delete c[d]);this._observable.destroy();delete this._observable;this.initForm("unbind");delete this.fields;delete this.groups;delete this.el;delete this.cfg}};l.defaults={};l.messages={};l.fieldDefaults={};l.groupDefaults={};l.addMethod=function(a,b,c){f[a]||(f[a]=b,c&&(l.messages[a]=c))};l.getValidator=function(b){b=b.getAttribute("data-validator");return a[b]||null};MetaphorJs.lib.Validator=l})()})();
